<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Testing - ABDRE</title>
    <link rel="icon" href="/static/img/favicon.ico" type="image/x-icon">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="/static/css/style.css">
    <style>
        .ws-test-result {
            padding: 8px;
            margin-bottom: 4px;
            border-radius: 4px;
        }
        .ws-test-result.info {
            background-color: #e9ecef;
        }
        .ws-test-result.success {
            background-color: #d4edda;
            color: #155724;
        }
        .ws-test-result.error {
            background-color: #f8d7da;
            color: #721c24;
        }
        #join-room-form {
            margin-bottom: 16px;
        }
        #message-form {
            margin-bottom: 16px;
        }
        #room-messages {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 16px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="/">ABDRE Chat</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarContent">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/my-chats">My Chats</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/login">Login</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mt-4">
        <div class="row">
            <div class="col-md-12">
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h4>WebSocket Testing</h4>
                        <div>
                            <button id="run-test-btn" class="btn btn-primary btn-sm">
                                <i class="bi bi-lightning-charge"></i> Run Test
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            This page allows you to test the WebSocket connection. You need to be logged in to run the tests.
                        </div>
                        
                        <div id="websocket-test-results" class="mb-4"></div>
                        
                        <hr>
                        
                        <h5>Manual Testing</h5>
                        
                        <div id="manual-testing" class="mt-3">
                            <!-- Join Room Form -->
                            <form id="join-room-form">
                                <div class="mb-3">
                                    <label for="room-id" class="form-label">Room ID</label>
                                    <input type="text" class="form-control" id="room-id" placeholder="Enter room ID">
                                </div>
                                <button type="submit" class="btn btn-primary">Join Room</button>
                            </form>
                            
                            <!-- Send Message Form -->
                            <form id="message-form">
                                <div class="mb-3">
                                    <label for="message-text" class="form-label">Message</label>
                                    <input type="text" class="form-control" id="message-text" placeholder="Enter message">
                                </div>
                                <button type="submit" class="btn btn-success">Send Message</button>
                            </form>
                            
                            <!-- Room Messages -->
                            <h6>Room Messages:</h6>
                            <div id="room-messages"></div>
                            
                            <!-- Connection Status -->
                            <div class="mb-3">
                                <span>Status: </span>
                                <span id="connection-status" class="badge bg-secondary">Not Connected</span>
                            </div>
                            
                            <button id="disconnect-btn" class="btn btn-danger">Disconnect</button>
                            <button id="reconnect-btn" class="btn btn-success">Connect</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Socket.IO -->
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    
    <!-- Utilities -->
    <script src="/static/js/utils/auth-helper.js"></script>
    <script src="/static/js/utils/state-manager.js"></script>
    <script src="/static/js/utils/websocket-tester.js"></script>
    
    <!-- Services -->
    <script src="/static/js/services/api-client.js"></script>
    <script src="/static/js/services/socket-client.js"></script>
    
    <!-- WebSocket Testing Script -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const runTestBtn = document.getElementById('run-test-btn');
            const joinRoomForm = document.getElementById('join-room-form');
            const messageForm = document.getElementById('message-form');
            const roomIdInput = document.getElementById('room-id');
            const messageInput = document.getElementById('message-text');
            const roomMessages = document.getElementById('room-messages');
            const connectionStatus = document.getElementById('connection-status');
            const disconnectBtn = document.getElementById('disconnect-btn');
            const reconnectBtn = document.getElementById('reconnect-btn');
            
            let currentRoom = null;
            
            // Check authentication
            if (!AuthHelper.isAuthenticated()) {
                document.getElementById('websocket-test-results').innerHTML = 
                    '<div class="ws-test-result error">You need to be logged in to test WebSockets. <a href="/login">Log in</a></div>';
                document.getElementById('manual-testing').style.display = 'none';
            }
            
            // Run automated test
            runTestBtn.addEventListener('click', () => {
                wsTestUtil.runTest();
            });
            
            // Update connection status display
            function updateConnectionStatus() {
                if (socketClient.connected) {
                    connectionStatus.textContent = 'Connected';
                    connectionStatus.className = 'badge bg-success';
                } else {
                    connectionStatus.textContent = 'Disconnected';
                    connectionStatus.className = 'badge bg-danger';
                }
            }
            
            // Initialize connection
            async function initConnection() {
                try {
                    await socketClient.init();
                    updateConnectionStatus();
                    
                    // Handle incoming messages
                    socketClient.on('message', (data) => {
                        const messageElement = document.createElement('div');
                        messageElement.className = 'ws-test-result info';
                        messageElement.textContent = `${data.sender_id}: ${data.content}`;
                        roomMessages.appendChild(messageElement);
                        // Auto-scroll
                        roomMessages.scrollTop = roomMessages.scrollHeight;
                    });
                } catch (error) {
                    console.error('Error connecting:', error);
                    connectionStatus.textContent = 'Connection Failed';
                    connectionStatus.className = 'badge bg-danger';
                }
            }
            
            // Initialize if authenticated
            if (AuthHelper.isAuthenticated()) {
                initConnection();
            }
            
            // Join room form
            joinRoomForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const roomId = roomIdInput.value.trim();
                if (!roomId) return;
                
                if (!socketClient.connected) {
                    alert('Not connected to WebSocket server. Please reconnect first.');
                    return;
                }
                
                // Join the room
                socketClient.joinRoom({
                    room_id: roomId,
                    visitor_id: AuthHelper.getUserId()
                });
                
                currentRoom = roomId;
                
                const joinMessage = document.createElement('div');
                joinMessage.className = 'ws-test-result success';
                joinMessage.textContent = `Joined room: ${roomId}`;
                roomMessages.appendChild(joinMessage);
            });
            
            // Send message form
            messageForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const message = messageInput.value.trim();
                if (!message) return;
                
                if (!currentRoom) {
                    alert('Please join a room first');
                    return;
                }
                
                if (!socketClient.connected) {
                    alert('Not connected to WebSocket server. Please reconnect first.');
                    return;
                }
                
                // Send the message
                socketClient.sendMessage({
                    room_id: currentRoom,
                    message: message
                });
                
                // Clear input
                messageInput.value = '';
            });
            
            // Disconnect button
            disconnectBtn.addEventListener('click', () => {
                socketClient.disconnect();
                updateConnectionStatus();
            });
            
            // Reconnect button
            reconnectBtn.addEventListener('click', () => {
                initConnection();
            });
        });
    </script>
</body>
</html> 