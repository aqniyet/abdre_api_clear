{% extends "layouts/app.html" %}

{% block page_title %}{{ chat_name }}{% endblock %}

{% block body_class %}layout-app page-app page-chat{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/pages/chat.css') }}">
{% endblock %}

{% block header_title %}
    <div class="chat-header-info">
        <div class="chat-avatar">
            {% if chat.is_group %}
                {% if chat.avatar_url %}
                <img src="{{ chat.avatar_url }}" alt="{{ chat.name }}">
                {% else %}
                <div class="avatar-placeholder">{{ chat.name[0:1] }}</div>
                {% endif %}
            {% else %}
                {% if chat.participant.avatar_url %}
                <img src="{{ chat.participant.avatar_url }}" alt="{{ chat.participant.display_name or chat.participant.username }}">
                {% else %}
                <div class="avatar-placeholder">{{ (chat.participant.display_name or chat.participant.username)[0:1] }}</div>
                {% endif %}
            {% endif %}
        </div>
        <div class="chat-details">
            <h1 class="chat-name">{{ chat_name }}</h1>
            <div class="chat-status">
                {% if is_group %}
                    {{ chat.participants|length }} members
                {% else %}
                    {% if is_online %}
                    <span class="status-indicator online"></span> Online
                    {% else %}
                    <span class="status-indicator offline"></span> Offline
                    {% endif %}
                {% endif %}
            </div>
        </div>
    </div>
{% endblock %}

{% block app_content %}
    <div class="chat-container">
        <div class="message-container" id="message-container">
            <div class="messages" id="messages">
                {% if is_empty %}
                    <div class="chat-start">
                        <div class="chat-start-content">
                            <div class="chat-start-icon">
                                <svg width="64" height="64" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M20 2H4C2.9 2 2 2.9 2 4V22L6 18H20C21.1 18 22 17.1 22 16V4C22 2.9 21.1 2 20 2ZM20 16H5.17L4 17.17V4H20V16Z" fill="currentColor"/>
                                </svg>
                            </div>
                            <h2>Start a conversation</h2>
                            <p>Send a message to begin chatting with {{ chat_name }}.</p>
                        </div>
                    </div>
                {% else %}
                    {% if day_separators %}
                        {% for day in day_separators %}
                        <div class="day-separator" id="day-{{ day.date }}">
                            <span class="day-text">{{ day.display }}</span>
                        </div>
                        {% endfor %}
                    {% endif %}
                    
                    {% for message in messages %}
                    <div class="message-wrapper {% if message.is_self %}self{% else %}other{% endif %}" id="message-{{ message.message_id }}" data-timestamp="{{ message.created_at }}">
                        <div class="message {% if message.is_self %}message-self{% else %}message-other{% endif %}">
                            {% if not message.is_self %}
                            <div class="message-sender">
                                <div class="message-avatar">
                                    {% if message.sender.avatar_url %}
                                    <img src="{{ message.sender.avatar_url }}" alt="{{ message.sender.display_name or message.sender.username }}">
                                    {% else %}
                                    <div class="avatar-placeholder">{{ (message.sender.display_name or message.sender.username)[0:1] }}</div>
                                    {% endif %}
                                </div>
                            </div>
                            {% endif %}
                            <div class="message-content">
                                <div class="message-bubble">
                                    <div class="message-text">{{ message.content }}</div>
                                </div>
                                <div class="message-meta">
                                    <span class="message-time">{{ message.created_at_formatted }}</span>
                                    {% if message.is_self %}
                                        {% if message.is_delivered %}
                                        <span class="message-status delivered" title="Delivered">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                <path d="M18 7L9.5 15.5L6 12L4.5 13.5L9.5 18.5L19.5 8.5L18 7Z" fill="currentColor"/>
                                            </svg>
                                        </span>
                                        {% elif message.is_read %}
                                        <span class="message-status read" title="Read">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                <path d="M18 7L9.5 15.5L6 12L4.5 13.5L9.5 18.5L19.5 8.5L18 7Z" fill="currentColor"/>
                                            </svg>
                                        </span>
                                        {% else %}
                                        <span class="message-status sent" title="Sent">
                                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                <path d="M9 16.17L4.83 12L3.41 13.41L9 19L21 7L19.59 5.59L9 16.17Z" fill="currentColor"/>
                                            </svg>
                                        </span>
                                        {% endif %}
                                    {% endif %}
                                </div>
                            </div>
                            <div class="message-actions dropdown">
                                <button class="message-actions-toggle dropdown-toggle" aria-label="Message actions" aria-expanded="false">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M12 8C13.1 8 14 7.1 14 6C14 4.9 13.1 4 12 4C10.9 4 10 4.9 10 6C10 7.1 10.9 8 12 8ZM12 10C10.9 10 10 10.9 10 12C10 13.1 10.9 14 12 14C13.1 14 14 13.1 14 12C14 10.9 13.1 10 12 10ZM12 16C10.9 16 10 16.9 10 18C10 19.1 10.9 20 12 20C13.1 20 14 19.1 14 18C14 16.9 13.1 16 12 16Z" fill="currentColor"/>
                                    </svg>
                                </button>
                                <div class="dropdown-menu">
                                    <ul class="dropdown-list">
                                        <li><button class="dropdown-btn copy-message-btn">
                                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                <path d="M16 1H4C2.9 1 2 1.9 2 3V17H4V3H16V1ZM19 5H8C6.9 5 6 5.9 6 7V21C6 22.1 6.9 23 8 23H19C20.1 23 21 22.1 21 21V7C21 5.9 20.1 5 19 5ZM19 21H8V7H19V21Z" fill="currentColor"/>
                                            </svg>
                                            Copy
                                        </button></li>
                                        {% if message.is_self %}
                                        <li><button class="dropdown-btn edit-message-btn">
                                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                <path d="M3 17.25V21H6.75L17.81 9.94L14.06 6.19L3 17.25ZM20.71 7.04C21.1 6.65 21.1 6.02 20.71 5.63L18.37 3.29C17.98 2.9 17.35 2.9 16.96 3.29L15.13 5.12L18.88 8.87L20.71 7.04Z" fill="currentColor"/>
                                            </svg>
                                            Edit
                                        </button></li>
                                        <li><button class="dropdown-btn delete-message-btn text-danger">
                                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                <path d="M6 19C6 20.1 6.9 21 8 21H16C17.1 21 18 20.1 18 19V7H6V19ZM19 4H15.5L14.5 3H9.5L8.5 4H5V6H19V4Z" fill="currentColor"/>
                                            </svg>
                                            Delete
                                        </button></li>
                                        {% else %}
                                        <li><button class="dropdown-btn reply-message-btn">
                                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                <path d="M10 9V5L3 12L10 19V15C15 15 18.5 16.5 21 20C20 15 17 10 10 9Z" fill="currentColor"/>
                                            </svg>
                                            Reply
                                        </button></li>
                                        <li><button class="dropdown-btn report-message-btn text-danger">
                                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                <path d="M15.73 3H8.27L3 8.27V15.73L8.27 21H15.73L21 15.73V8.27L15.73 3ZM19 14.9L14.9 19H9.1L5 14.9V9.1L9.1 5H14.9L19 9.1V14.9Z" fill="currentColor"/>
                                                <path d="M12 17C12.83 17 13.5 16.33 13.5 15.5C13.5 14.67 12.83 14 12 14C11.17 14 10.5 14.67 10.5 15.5C10.5 16.33 11.17 17 12 17Z" fill="currentColor"/>
                                                <path d="M13 7H11V13H13V7Z" fill="currentColor"/>
                                            </svg>
                                            Report
                                        </button></li>
                                        {% endif %}
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% endif %}
            </div>
            
            <div id="scroll-to-bottom" class="scroll-to-bottom">
                <button class="scroll-btn" aria-label="Scroll to bottom">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M16.59 8.59L12 13.17L7.41 8.59L6 10L12 16L18 10L16.59 8.59Z" fill="currentColor"/>
                    </svg>
                </button>
            </div>
        </div>
        
        <div class="message-input-container">
            <div class="message-reply" id="reply-container" style="display: none;">
                <div class="reply-preview">
                    <div class="reply-content">
                        <div class="reply-sender" id="reply-sender"></div>
                        <div class="reply-text" id="reply-text"></div>
                    </div>
                </div>
                <button type="button" class="reply-close-btn" id="reply-close-btn" aria-label="Close reply">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M19 6.41L17.59 5L12 10.59L6.41 5L5 6.41L10.59 12L5 17.59L6.41 19L12 13.41L17.59 19L19 17.59L13.41 12L19 6.41Z" fill="currentColor"/>
                    </svg>
                </button>
            </div>
            
            <form id="message-form" class="message-form">
                <div class="message-input-wrapper">
                    <div class="message-attachments">
                        <button type="button" class="attachment-btn" aria-label="Add attachment">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M16.5 6V17.5C16.5 19.71 14.71 21.5 12.5 21.5C10.29 21.5 8.5 19.71 8.5 17.5V5C8.5 3.62 9.62 2.5 11 2.5C12.38 2.5 13.5 3.62 13.5 5V15.5C13.5 16.05 13.05 16.5 12.5 16.5C11.95 16.5 11.5 16.05 11.5 15.5V6H10V15.5C10 16.88 11.12 18 12.5 18C13.88 18 15 16.88 15 15.5V5C15 2.79 13.21 1 11 1C8.79 1 7 2.79 7 5V17.5C7 20.54 9.46 23 12.5 23C15.54 23 18 20.54 18 17.5V6H16.5Z" fill="currentColor"/>
                            </svg>
                        </button>
                    </div>
                    <div class="message-editor">
                        <textarea 
                            id="message-input" 
                            class="message-input" 
                            placeholder="Type a message..." 
                            rows="1"
                            autofocus
                        ></textarea>
                    </div>
                    <div class="message-actions">
                        <button type="button" class="emoji-btn" aria-label="Add emoji">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M11.99 2C6.47 2 2 6.48 2 12C2 17.52 6.47 22 11.99 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 11.99 2ZM12 20C7.58 20 4 16.42 4 12C4 7.58 7.58 4 12 4C16.42 4 20 7.58 20 12C20 16.42 16.42 20 12 20ZM15.5 11C16.33 11 17 10.33 17 9.5C17 8.67 16.33 8 15.5 8C14.67 8 14 8.67 14 9.5C14 10.33 14.67 11 15.5 11ZM8.5 11C9.33 11 10 10.33 10 9.5C10 8.67 9.33 8 8.5 8C7.67 8 7 8.67 7 9.5C7 10.33 7.67 11 8.5 11ZM12 17.5C14.33 17.5 16.31 16.04 17.11 14H6.89C7.69 16.04 9.67 17.5 12 17.5Z" fill="currentColor"/>
                            </svg>
                        </button>
                    </div>
                </div>
                <button type="submit" class="send-btn" aria-label="Send message">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M2.01 21L23 12L2.01 3L2 10L17 12L2 14L2.01 21Z" fill="currentColor"/>
                    </svg>
                </button>
            </form>
        </div>
    </div>
{% endblock %}

{% block header_actions %}
    <div id="connection-status" class="connection-status connection-status--{{ initial_connection_status|default('connecting') }}">
        <div class="connection-status__indicator"></div>
        <div class="connection-status__details">
            <span class="connection-status__text">
                {% if initial_connection_status == 'connected' %}
                Connected
                {% elif initial_connection_status == 'connecting' %}
                Connecting...
                {% else %}
                Disconnected
                {% endif %}
            </span>
            <span class="connection-status__latency"></span>
        </div>
        <button id="connection-reconnect" class="connection-status__reconnect-btn" title="Reconnect">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4C7.58 4 4.01 7.58 4.01 12C4.01 16.42 7.58 20 12 20C15.73 20 18.84 17.45 19.73 14H17.65C16.83 16.33 14.61 18 12 18C8.69 18 6 15.31 6 12C6 8.69 8.69 6 12 6C13.66 6 15.14 6.69 16.22 7.78L13 11H20V4L17.65 6.35Z" fill="currentColor"/>
            </svg>
        </button>
    </div>
    <div class="chat-menu dropdown">
        <button class="chat-menu-toggle dropdown-toggle" aria-label="Chat menu" aria-expanded="false" aria-controls="chat-dropdown">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 8C13.1 8 14 7.1 14 6C14 4.9 13.1 4 12 4C10.9 4 10 4.9 10 6C10 7.1 10.9 8 12 8ZM12 10C10.9 10 10 10.9 10 12C10 13.1 10.9 14 12 14C13.1 14 14 13.1 14 12C14 10.9 13.1 10 12 10ZM12 16C10.9 16 10 16.9 10 18C10 19.1 10.9 20 12 20C13.1 20 14 19.1 14 18C14 16.9 13.1 16 12 16Z" fill="currentColor"/>
            </svg>
        </button>
        <div id="chat-dropdown" class="dropdown-menu">
            <ul class="dropdown-list">
                {% if chat.is_group %}
                <li><a href="/chat/{{ chat_id }}/members">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M16 11C17.66 11 18.99 9.66 18.99 8C18.99 6.34 17.66 5 16 5C14.34 5 13 6.34 13 8C13 9.66 14.34 11 16 11ZM8 11C9.66 11 10.99 9.66 10.99 8C10.99 6.34 9.66 5 8 5C6.34 5 5 6.34 5 8C5 9.66 6.34 11 8 11ZM8 13C5.67 13 1 14.17 1 16.5V19H15V16.5C15 14.17 10.33 13 8 13ZM16 13C15.71 13 15.38 13.02 15.03 13.05C16.19 13.89 17 15.02 17 16.5V19H23V16.5C23 14.17 18.33 13 16 13Z" fill="currentColor"/>
                    </svg>
                    Manage Members
                </a></li>
                <li><a href="/chat/{{ chat_id }}/share">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M18 16.08C17.24 16.08 16.56 16.38 16.04 16.85L8.91 12.7C8.96 12.47 9 12.24 9 12C9 11.76 8.96 11.53 8.91 11.3L15.96 7.19C16.5 7.69 17.21 8 18 8C19.66 8 21 6.66 21 5C21 3.34 19.66 2 18 2C16.34 2 15 3.34 15 5C15 5.24 15.04 5.47 15.09 5.7L8.04 9.81C7.5 9.31 6.79 9 6 9C4.34 9 3 10.34 3 12C3 13.66 4.34 15 6 15C6.79 15 7.5 14.69 8.04 14.19L15.16 18.35C15.11 18.56 15.08 18.78 15.08 19C15.08 20.61 16.39 21.92 18 21.92C19.61 21.92 20.92 20.61 20.92 19C20.92 17.39 19.61 16.08 18 16.08Z" fill="currentColor"/>
                    </svg>
                    Share Group
                </a></li>
                {% else %}
                <li><a href="/chat/{{ chat_id }}/info">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM12 20C7.59 20 4 16.41 4 12C4 7.59 7.59 4 12 4C16.41 4 20 7.59 20 12C20 16.41 16.41 20 12 20ZM11 17H13V11H11V17ZM11 9H13V7H11V9Z" fill="currentColor"/>
                    </svg>
                    Contact Info
                </a></li>
                {% endif %}
                <li><a href="#" id="clear-chat-btn">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M15 16H19V18H15V16ZM15 8H22V10H15V8ZM15 12H21V14H15V12ZM3 18C3 19.1 3.9 20 5 20H11C12.1 20 13 19.1 13 18V8H3V18ZM5 10H11V18H5V10ZM10 4H6L5 5H2V7H14V5H11L10 4Z" fill="currentColor"/>
                    </svg>
                    Clear Chat
                </a></li>
                <li class="dropdown-divider"></li>
                <li><a href="#" id="block-chat-btn" class="text-danger">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM12 4C16.42 4 20 7.58 20 12C20 13.85 19.37 15.55 18.31 16.9L7.1 5.69C8.45 4.63 10.15 4 12 4ZM4 12C4 10.15 4.63 8.45 5.69 7.1L16.9 18.31C15.55 19.37 13.85 20 12 20C7.58 20 4 16.42 4 12Z" fill="currentColor"/>
                    </svg>
                    Block & Report
                </a></li>
            </ul>
        </div>
    </div>
{% endblock %}

{% block app_js %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize modules
            ABDRE.EventBus.init();
            ABDRE.RealtimeService.init().connect();
            ABDRE.Enhancers.ConnectionStatus.init();
            ABDRE.Enhancers.Dropdown.init();
            
            // Initialize chat data with properly formatted JSON
            var chatId = "{{ chat_id }}";
            var messagesData = JSON.parse('{{ messages_json|safe }}');
            
            ABDRE.Enhancers.Chat.init(chatId, messagesData);
            ABDRE.Enhancers.MessageInput.init();
        });
    </script>
{% endblock %}

{% block extra_js %}
    {{ super() }}
    <script src="{{ url_for('static', filename='js/services/api_service.js') }}"></script>
    <script src="{{ url_for('static', filename='js/services/chat_service.js') }}"></script>
    <script src="{{ url_for('static', filename='js/enhancers/chat_enhancer.js') }}"></script>
    <script src="{{ url_for('static', filename='js/enhancers/message_input_enhancer.js') }}"></script>
{% endblock %} 