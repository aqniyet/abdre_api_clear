{% extends "layouts/app.html" %}

{% block page_title %}Create Chat{% endblock %}

{% block body_class %}layout-app page-app page-create-chat{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/pages/create.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components/qr_invite.css') }}">
{% endblock %}

{% block header_title %}
    <h1 class="header-title">Create Chat</h1>
{% endblock %}

{% block app_content %}
    <div class="page-header">
        <h1>Create New Chat</h1>
    </div>
    
    <div class="create-options">
        <div class="create-option-card">
            <div class="create-option-icon">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 12C14.21 12 16 10.21 16 8C16 5.79 14.21 4 12 4C9.79 4 8 5.79 8 8C8 10.21 9.79 12 12 12ZM12 14C9.33 14 4 15.34 4 18V20H20V18C20 15.34 14.67 14 12 14Z" fill="currentColor"/>
                </svg>
            </div>
            <h3>Direct Chat</h3>
            <p>Start a one-on-one conversation with another user.</p>
            <button type="button" class="btn btn-primary" id="create-direct-btn">Start Direct Chat</button>
        </div>
        
        <div class="create-option-card">
            <div class="create-option-icon">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M18 8H17V6C17 3.24 14.76 1 12 1C9.24 1 7 3.24 7 6V8H6C4.9 8 4 8.9 4 10V20C4 21.1 4.9 22 6 22H18C19.1 22 20 21.1 20 20V10C20 8.9 19.1 8 18 8ZM12 17C10.9 17 10 16.1 10 15C10 13.9 10.9 13 12 13C13.1 13 14 13.9 14 15C14 16.1 13.1 17 12 17ZM15.1 8H8.9V6C8.9 4.29 10.29 2.9 12 2.9C13.71 2.9 15.1 4.29 15.1 6V8Z" fill="currentColor"/>
                </svg>
            </div>
            <h3>Private Group</h3>
            <p>Create a private conversation with multiple members.</p>
            <button type="button" class="btn btn-primary" id="create-group-btn">Create Group</button>
        </div>
        
        <div class="create-option-card">
            <div class="create-option-icon">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M3 5V19L8 14H17C18.1 14 19 13.1 19 12V5C19 3.9 18.1 3 17 3H5C3.9 3 3 3.9 3 5ZM21 17H7L3 21V5C3 3.9 3.9 3 5 3H21C22.1 3 23 3.9 23 5V15C23 16.1 22.1 17 21 17Z" fill="currentColor"/>
                </svg>
            </div>
            <h3>QR Code Invitation</h3>
            <p>Generate a QR code that others can scan to join your chat.</p>
            <button type="button" class="btn btn-primary" id="create-qr-btn">Create QR Invitation</button>
        </div>
    </div>
    
    <!-- Include the QR invite modal component -->
    {% include 'components/qr_invite.html' %}
{% endblock %}

{% block app_js %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize modules
            ABDRE.EventBus.init();
            ABDRE.RealtimeService.init({
                host: window.location.host,
                path: '/api/realtime/socket.io/',
                authToken: 'guest'
            }).connect();
            ABDRE.Enhancers.ConnectionStatus.init();
            ABDRE.Enhancers.CreateChat.init();
            
            // Initialize QR invitation service
            if (ABDRE.Services.QRInvitation) {
                ABDRE.Services.QRInvitation.init({
                    onAccepted: function(data) {
                        // Redirect to the newly created chat
                        if (data.chat_id) {
                            window.location.href = `/chat/${data.chat_id}`;
                        }
                    }
                });
                
                // Handle hash fragment in URL
                if (window.location.hash) {
                    const hash = window.location.hash.substring(1);
                    if (hash === 'qr') {
                        // Show QR code invitation modal
                        setTimeout(function() {
                            ABDRE.Services.QRInvitation.showQRInvitation();
                        }, 300);
                    }
                }
                
                // Hook up the QR code button
                const qrButton = document.getElementById('create-qr-btn');
                if (qrButton) {
                    qrButton.addEventListener('click', function() {
                        ABDRE.Services.QRInvitation.showQRInvitation();
                    });
                }
            }
            
            // Handle hash fragment for direct and group options
            if (window.location.hash) {
                const hash = window.location.hash.substring(1);
                
                // Find the correct tab based on hash
                if (hash === 'direct' || hash === 'group') {
                    // Here we would activate the correct tab if using tabs,
                    // or trigger a specific action based on the hash
                    
                    const directButton = document.getElementById('create-direct-btn');
                    const groupButton = document.getElementById('create-group-btn');
                    
                    if (hash === 'direct' && directButton) {
                        // Simulate a click on the direct chat button
                        directButton.click();
                    } else if (hash === 'group' && groupButton) {
                        // Simulate a click on the group chat button
                        groupButton.click();
                    }
                }
            }
        });
    </script>
{% endblock %}

{% block extra_js %}
    {{ super() }}
    <script src="{{ url_for('static', filename='js/services/api_service.js') }}"></script>
    <script src="{{ url_for('static', filename='js/services/chat_service.js') }}"></script>
    <script src="{{ url_for('static', filename='js/services/qr_invitation_service.js') }}"></script>
    <script src="{{ url_for('static', filename='js/enhancers/create_chat_enhancer.js') }}"></script>
{% endblock %} 