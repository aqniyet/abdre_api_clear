<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Test - ABDRE</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px;
            background-color: #f8f9fa;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            padding: 20px;
        }
        .card {
            margin-bottom: 20px;
        }
        .event-log {
            height: 300px;
            overflow-y: auto;
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #dee2e6;
            font-family: monospace;
        }
        .log-entry {
            margin-bottom: 5px;
            word-wrap: break-word;
        }
        .log-entry.success {
            color: #28a745;
        }
        .log-entry.error {
            color: #dc3545;
        }
        .log-entry.info {
            color: #17a2b8;
        }
        .log-entry.warning {
            color: #ffc107;
        }
        code {
            background-color: #f8f9fa;
            padding: 2px 4px;
            border-radius: 3px;
            font-size: 90%;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mb-4 mt-2">WebSocket Test</h1>
        <p class="lead">This page tests WebSocket connectivity to the ABDRE realtime service.</p>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="card-title mb-0">Connection Status</h5>
                    </div>
                    <div class="card-body">
                        <div id="connection-status-container">
                            <p>Status: <span id="connection-status" class="badge bg-secondary">Initializing...</span></p>
                            <p>Socket ID: <span id="socket-id">None</span></p>
                            <p>Connection Mode: <span id="connection-mode">Unknown</span></p>
                            <p>Auth Status: <span id="auth-status" class="badge bg-secondary">Unknown</span></p>
                            <p>Last Activity: <span id="last-activity">None</span></p>
                        </div>
                        <div class="d-grid gap-2">
                            <button id="connect-btn" class="btn btn-primary">Connect</button>
                            <button id="disconnect-btn" class="btn btn-danger" disabled>Disconnect</button>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5 class="card-title mb-0">Tests</h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button id="test-ping" class="btn btn-outline-primary" disabled>Test Ping</button>
                            <button id="test-broadcast" class="btn btn-outline-success" disabled>Test Broadcast</button>
                            <button id="test-join-room" class="btn btn-outline-info" disabled>Join Test Room</button>
                            <button id="test-send-message" class="btn btn-outline-dark" disabled>Send Test Message</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5 class="card-title mb-0">Event Log</h5>
                        <button id="clear-log" class="btn btn-sm btn-light float-end mt-n2">Clear</button>
                    </div>
                    <div class="card-body">
                        <div id="event-log" class="event-log"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header bg-warning text-dark">
                <h5 class="card-title mb-0">Service Configuration</h5>
            </div>
            <div class="card-body">
                <div id="config-info">Loading configuration...</div>
            </div>
        </div>
    </div>
    
    <!-- Socket.IO from CDN -->
    <script src="https://cdn.jsdelivr.net/npm/socket.io-client@4.6.1/dist/socket.io.min.js"></script>
    
    <!-- Core scripts -->
    <script src="/static/js/utils/auth-helper.js"></script>
    <script src="/static/js/services/socket-client.js"></script>
    
    <script>
        // DOM elements
        const connectBtn = document.getElementById('connect-btn');
        const disconnectBtn = document.getElementById('disconnect-btn');
        const testPingBtn = document.getElementById('test-ping');
        const testBroadcastBtn = document.getElementById('test-broadcast');
        const testJoinRoomBtn = document.getElementById('test-join-room');
        const testSendMessageBtn = document.getElementById('test-send-message');
        const clearLogBtn = document.getElementById('clear-log');
        const eventLog = document.getElementById('event-log');
        const connectionStatus = document.getElementById('connection-status');
        const socketId = document.getElementById('socket-id');
        const connectionMode = document.getElementById('connection-mode');
        const authStatus = document.getElementById('auth-status');
        const lastActivity = document.getElementById('last-activity');
        const configInfo = document.getElementById('config-info');
        
        // Test room for joining
        const TEST_ROOM = 'ws-test-room';
        
        // Log messages to the event log
        function log(message, type = 'info') {
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${message}`;
            
            eventLog.appendChild(entry);
            eventLog.scrollTop = eventLog.scrollHeight;
            
            // Update last activity
            lastActivity.textContent = timestamp;
        }
        
        // Clear the event log
        clearLogBtn.addEventListener('click', () => {
            eventLog.innerHTML = '';
            log('Log cleared', 'info');
        });
        
        // Initialize auth helper
        if (typeof AuthHelper !== 'undefined') {
            AuthHelper.init();
            
            if (AuthHelper.isAuthenticated()) {
                log(`Authenticated as user: ${AuthHelper.getUserId()}`, 'success');
                authStatus.textContent = 'Authenticated';
                authStatus.className = 'badge bg-success';
            } else {
                log('Not authenticated, continuing as guest', 'warning');
                authStatus.textContent = 'Guest';
                authStatus.className = 'badge bg-warning';
            }
        } else {
            log('AuthHelper not available', 'error');
            authStatus.textContent = 'Error';
            authStatus.className = 'badge bg-danger';
        }
        
        // Fetch service configuration
        fetch('/api/realtime/check-connection')
            .then(response => response.json())
            .then(data => {
                if (data.status === 'available') {
                    log(`Realtime service available at ${data.realtime_service}`, 'success');
                    
                    // Display configuration
                    configInfo.innerHTML = `
                        <ul>
                            <li><strong>Realtime Service URL:</strong> ${data.realtime_service}</li>
                            <li><strong>Socket.IO Path:</strong> ${data.socket_io_path}</li>
                            <li><strong>Authentication:</strong> ${data.authenticated ? 'Yes' : 'No'}</li>
                            <li><strong>User ID:</strong> ${data.user_id}</li>
                            <li><strong>Socket Endpoint:</strong> ${data.socket_endpoint}</li>
                        </ul>
                    `;
                    
                    // Enable connect button
                    connectBtn.disabled = false;
                } else {
                    log(`Realtime service unavailable: ${data.message}`, 'error');
                    configInfo.innerHTML = `
                        <div class="alert alert-danger">
                            <strong>Error:</strong> Realtime service unavailable
                            <p>${data.message}</p>
                        </div>
                    `;
                }
            })
            .catch(error => {
                log(`Error fetching configuration: ${error.message}`, 'error');
                configInfo.innerHTML = `
                    <div class="alert alert-danger">
                        <strong>Error:</strong> ${error.message}
                    </div>
                `;
            });
        
        // Connect button
        connectBtn.addEventListener('click', () => {
            connectionStatus.textContent = 'Connecting...';
            connectionStatus.className = 'badge bg-warning';
            log('Initializing socket connection...', 'info');
            
            try {
                // Initialize the socket client
                SocketClient.init();
                
                // Add connection change listener
                SocketClient.onConnectionChange(connected => {
                    updateConnectionStatus(connected);
                });
                
                // Listen for connection events
                SocketClient.on('connect', () => {
                    log('Socket connected!', 'success');
                    socketId.textContent = SocketClient._socket.id;
                    
                    // Update connection mode
                    if (SocketClient._directConnectionUrl) {
                        connectionMode.textContent = `Direct (${SocketClient._directConnectionUrl})`;
                    } else {
                        connectionMode.textContent = 'API Gateway Proxy';
                    }
                    
                    // Enable test buttons
                    enableTestButtons(true);
                });
                
                SocketClient.on('disconnect', (reason) => {
                    log(`Socket disconnected: ${reason}`, 'error');
                    socketId.textContent = 'None';
                    enableTestButtons(false);
                });
                
                SocketClient.on('error', (error) => {
                    log(`Socket error: ${error}`, 'error');
                });
                
                SocketClient.on('message', (data) => {
                    log(`Received message: ${JSON.stringify(data)}`, 'info');
                });
                
                SocketClient.on('pong', (data) => {
                    log(`Received pong: ${JSON.stringify(data)}`, 'success');
                });
                
                SocketClient.on('join', (data) => {
                    log(`User joined room: ${JSON.stringify(data)}`, 'info');
                });
                
                // Disable connect button and enable disconnect
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
            } catch (error) {
                log(`Error initializing socket: ${error.message}`, 'error');
                connectionStatus.textContent = 'Error';
                connectionStatus.className = 'badge bg-danger';
            }
        });
        
        // Disconnect button
        disconnectBtn.addEventListener('click', () => {
            if (SocketClient._socket) {
                SocketClient.disconnect();
                log('Socket disconnected by user', 'warning');
                
                // Update UI
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
                enableTestButtons(false);
                updateConnectionStatus(false);
            }
        });
        
        // Test ping button
        testPingBtn.addEventListener('click', () => {
            log('Sending ping...', 'info');
            
            SocketClient.testConnection()
                .then(result => {
                    log(`Ping successful! Latency: ${result.latency}ms`, 'success');
                })
                .catch(error => {
                    log(`Ping failed: ${error.message}`, 'error');
                });
        });
        
        // Test broadcast button
        testBroadcastBtn.addEventListener('click', () => {
            const testMessage = {
                message: `Test broadcast at ${new Date().toISOString()}`,
                sender: 'WebSocket Test Page'
            };
            
            log(`Sending test broadcast: ${JSON.stringify(testMessage)}`, 'info');
            
            fetch('/api/ws-test', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(testMessage)
            })
            .then(response => response.json())
            .then(data => {
                log(`Broadcast response: ${JSON.stringify(data)}`, 'success');
            })
            .catch(error => {
                log(`Broadcast error: ${error.message}`, 'error');
            });
        });
        
        // Test join room button
        testJoinRoomBtn.addEventListener('click', () => {
            log(`Joining test room: ${TEST_ROOM}`, 'info');
            
            SocketClient.joinRoom(TEST_ROOM)
                .then(() => {
                    log(`Successfully joined room: ${TEST_ROOM}`, 'success');
                    testSendMessageBtn.disabled = false;
                })
                .catch(error => {
                    log(`Error joining room: ${error.message}`, 'error');
                });
        });
        
        // Test send message button
        testSendMessageBtn.addEventListener('click', () => {
            const testMessage = `Test message from WebSocket Test Page at ${new Date().toISOString()}`;
            log(`Sending test message to ${TEST_ROOM}: ${testMessage}`, 'info');
            
            SocketClient.sendMessage(TEST_ROOM, testMessage)
                .then(result => {
                    log(`Message sent successfully: ${JSON.stringify(result)}`, 'success');
                })
                .catch(error => {
                    log(`Error sending message: ${error.message}`, 'error');
                });
        });
        
        // Helper functions
        function updateConnectionStatus(connected) {
            if (connected) {
                connectionStatus.textContent = 'Connected';
                connectionStatus.className = 'badge bg-success';
            } else {
                connectionStatus.textContent = 'Disconnected';
                connectionStatus.className = 'badge bg-danger';
                socketId.textContent = 'None';
                connectionMode.textContent = 'Unknown';
            }
        }
        
        function enableTestButtons(enabled) {
            testPingBtn.disabled = !enabled;
            testBroadcastBtn.disabled = !enabled;
            testJoinRoomBtn.disabled = !enabled;
            testSendMessageBtn.disabled = !enabled || !SocketClient._subscribedRooms.has(TEST_ROOM);
        }
        
        // Initial setup
        log('WebSocket test page loaded', 'info');
    </script>
</body>
</html> 