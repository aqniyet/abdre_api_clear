<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Join Chat | ABDRE Chat</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body class="page-invitation">
    <header class="app-header">
        <div class="container">
            <div class="header-content">
                <a href="/" class="header-back">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M20 11H7.83L13.42 5.41L12 4L4 12L12 20L13.41 18.59L7.83 13H20V11Z" fill="currentColor"/>
                    </svg>
                </a>
                <h1 class="header-title">Join Chat</h1>
            </div>
            {% include 'components/connection_status.html' %}
        </div>
    </header>

    <main class="container">
        <div class="invitation-container">
            <!-- Loading State -->
            <div id="invitation-loading" class="invitation-state invitation-loading">
                <div class="loading-spinner"></div>
                <p>Loading invitation details...</p>
            </div>
            
            <!-- Valid Invitation State -->
            <div id="invitation-valid" class="invitation-state invitation-valid" style="display: none;">
                <div class="invitation-icon">
                    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M20 4H4C2.9 4 2 4.9 2 6V18C2 19.1 2.9 20 4 20H20C21.1 20 22 19.1 22 18V6C22 4.9 21.1 4 20 4ZM20 18H4V6H20V18ZM4 0H20V2H4V0ZM4 22H20V24H4V22ZM12 11C13.65 11 15 9.65 15 8C15 6.35 13.65 5 12 5C10.35 5 9 6.35 9 8C9 9.65 10.35 11 12 11ZM12 7C12.55 7 13 7.45 13 8C13 8.55 12.55 9 12 9C11.45 9 11 8.55 11 8C11 7.45 11.45 7 12 7ZM18 15.58C18 13.08 14.03 12 12 12C9.97 12 6 13.08 6 15.58V17H18V15.58ZM8.48 15C9.22 14.49 10.71 14 12 14C13.3 14 14.78 14.49 15.52 15H8.48Z" fill="currentColor"/>
                    </svg>
                </div>
                
                <div class="invitation-details">
                    <h2>You've been invited to join</h2>
                    <h3 id="chat-name"></h3>
                    <p id="invitation-note" class="invitation-note"></p>
                    
                    <div class="invitation-meta">
                        <div class="invitation-meta-item">
                            <span class="meta-label">Invited by:</span>
                            <span id="inviter-name" class="meta-value"></span>
                        </div>
                        <div class="invitation-meta-item">
                            <span class="meta-label">Expires:</span>
                            <span id="expiration-date" class="meta-value"></span>
                        </div>
                    </div>
                </div>
                
                <div class="invitation-actions">
                    <button type="button" class="btn btn-secondary" id="decline-btn">Decline</button>
                    <button type="button" class="btn btn-primary" id="accept-btn">Accept & Join Chat</button>
                </div>
            </div>
            
            <!-- Expired Invitation State -->
            <div id="invitation-expired" class="invitation-state invitation-error" style="display: none;">
                <div class="error-icon">
                    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M11 15h2v2h-2v-2zm0-8h2v6h-2V7zm.99-5C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8z" fill="currentColor"/>
                    </svg>
                </div>
                <h2>Invitation Expired</h2>
                <p>This invitation is no longer valid. It may have expired or reached its maximum number of uses.</p>
                <div class="invitation-actions">
                    <a href="/chats" class="btn btn-primary">Go to Chats</a>
                </div>
            </div>
            
            <!-- Invalid Invitation State -->
            <div id="invitation-invalid" class="invitation-state invitation-error" style="display: none;">
                <div class="error-icon">
                    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z" fill="currentColor"/>
                    </svg>
                </div>
                <h2>Invalid Invitation</h2>
                <p>This invitation code is not valid. Please check the URL and try again.</p>
                <div class="invitation-actions">
                    <a href="/chats" class="btn btn-primary">Go to Chats</a>
                </div>
            </div>
            
            <!-- Already Member State -->
            <div id="invitation-already-member" class="invitation-state invitation-info" style="display: none;">
                <div class="info-icon">
                    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z" fill="currentColor"/>
                    </svg>
                </div>
                <h2>Already a Member</h2>
                <p>You're already a member of this chat.</p>
                <div class="invitation-actions">
                    <a id="go-to-chat-link" href="#" class="btn btn-primary">Go to Chat</a>
                </div>
            </div>
            
            <!-- Need Login State -->
            <div id="invitation-need-login" class="invitation-state invitation-info" style="display: none;">
                <div class="info-icon">
                    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z" fill="currentColor"/>
                    </svg>
                </div>
                <h2>Login Required</h2>
                <p>You need to log in to join this chat.</p>
                <div class="invitation-actions">
                    <a href="/login?redirect=/invite/{{ invitation_code }}" class="btn btn-primary">Log In</a>
                    <a href="/register?redirect=/invite/{{ invitation_code }}" class="btn btn-outline">Register</a>
                </div>
            </div>
            
            <!-- Success State -->
            <div id="invitation-success" class="invitation-state invitation-success" style="display: none;">
                <div class="success-icon">
                    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z" fill="currentColor"/>
                    </svg>
                </div>
                <h2>Successfully Joined!</h2>
                <p>You have successfully joined the chat.</p>
                <div class="invitation-actions">
                    <a id="success-go-to-chat-link" href="#" class="btn btn-primary">Go to Chat</a>
                </div>
            </div>
        </div>
    </main>

    <!-- JavaScript -->
    <script src="/static/js/core/event_bus.js"></script>
    <script src="/static/js/services/realtime_service.js"></script>
    <script src="/static/js/services/api_service.js"></script>
    <script src="/static/js/services/invitation_service.js"></script>
    <script src="/static/js/enhancers/connection_status_enhancer.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize modules
            ABDRE.EventBus.init();
            ABDRE.RealtimeService.init().connect();
            ABDRE.Enhancers.ConnectionStatus.init();
            ABDRE.InvitationService.init();
            
            const invitationCode = '{{ invitation_code }}';
            
            // Elements
            const loadingState = document.getElementById('invitation-loading');
            const validState = document.getElementById('invitation-valid');
            const expiredState = document.getElementById('invitation-expired');
            const invalidState = document.getElementById('invitation-invalid');
            const alreadyMemberState = document.getElementById('invitation-already-member');
            const needLoginState = document.getElementById('invitation-need-login');
            const successState = document.getElementById('invitation-success');
            
            // Information elements
            const chatNameEl = document.getElementById('chat-name');
            const invitationNoteEl = document.getElementById('invitation-note');
            const inviterNameEl = document.getElementById('inviter-name');
            const expirationDateEl = document.getElementById('expiration-date');
            const goToChatLink = document.getElementById('go-to-chat-link');
            const successGoToChatLink = document.getElementById('success-go-to-chat-link');
            
            // Action buttons
            const acceptBtn = document.getElementById('accept-btn');
            const declineBtn = document.getElementById('decline-btn');
            
            // Helper to show only one state
            function showState(stateElement) {
                [loadingState, validState, expiredState, invalidState, alreadyMemberState, needLoginState, successState].forEach(el => {
                    el.style.display = 'none';
                });
                
                stateElement.style.display = 'block';
            }
            
            // Helper to format date
            function formatDate(dateString) {
                const date = new Date(dateString);
                return date.toLocaleString();
            }
            
            // Fetch invitation details
            ABDRE.InvitationService.getInvitationInfo(invitationCode)
                .then(invitation => {
                    // Check invitation status
                    if (invitation.is_expired) {
                        showState(expiredState);
                        return;
                    }
                    
                    if (invitation.is_already_member) {
                        showState(alreadyMemberState);
                        goToChatLink.href = `/chat/${invitation.chat_id}`;
                        return;
                    }
                    
                    if (invitation.needs_authentication) {
                        showState(needLoginState);
                        return;
                    }
                    
                    // Valid invitation
                    showState(validState);
                    
                    // Fill in details
                    chatNameEl.textContent = invitation.chat_name;
                    inviterNameEl.textContent = invitation.inviter_name;
                    
                    if (invitation.note) {
                        invitationNoteEl.textContent = `"${invitation.note}"`;
                        invitationNoteEl.style.display = 'block';
                    } else {
                        invitationNoteEl.style.display = 'none';
                    }
                    
                    if (invitation.expires_at) {
                        expirationDateEl.textContent = formatDate(invitation.expires_at);
                    } else {
                        expirationDateEl.textContent = 'Never';
                    }
                    
                    // Setup accept button
                    acceptBtn.addEventListener('click', function() {
                        acceptBtn.disabled = true;
                        acceptBtn.textContent = 'Joining...';
                        
                        ABDRE.InvitationService.acceptInvitation(invitationCode)
                            .then(result => {
                                showState(successState);
                                successGoToChatLink.href = `/chat/${result.chat_id}`;
                            })
                            .catch(error => {
                                acceptBtn.disabled = false;
                                acceptBtn.textContent = 'Accept & Join Chat';
                                alert('Failed to join chat: ' + (error.message || 'Unknown error'));
                            });
                    });
                    
                    // Setup decline button
                    declineBtn.addEventListener('click', function() {
                        window.location.href = '/chats';
                    });
                })
                .catch(error => {
                    console.error('Error loading invitation:', error);
                    showState(invalidState);
                });
        });
    </script>
</body>
</html> 